**EXPERIMENTAL: This chart guarantees no compatability with future versions and is subject to change**

# Prefect Server Helm Chart

## Usage

1. Clone repository

2. Change to this directory

3. Download the postgresql dependency if you are not using an existing database

```
$ helm dependency update
```

4. Install the chart with your desired name e.g. "my-prefect-server"

```
$ helm install <name-to-label-release> . [helm options]
```

### Upgrading

Upgrades can be run with the following command
```
$ helm upgrade <name-of-last-release> .
```

This will only update infrastructure that is modified.
You will need to continue to set any values that you set during the original install (e.g. `--set agent.enabled=true`).
Note that if you are using the postgresql subchart with an autogenerated password, it will complain that you have not
provided that password for the upgrade.
Export the password as the error asks then set it within the subchart using `--set postgresql.postgresqlPassword=$POSTGRESQL_PASSWORD`


## Options:

See comments in `values.yaml`.


### KubernetesAgent

A [Prefect KubernetesAgent](https://docs.prefect.io/orchestration/agents/kubernetes.html) that queries for flows and runs them on your cluster can be installed but is not included by default.
Add the flag `--set agent.enabled=true` to the `helm install` command to include the agent.

### Database

The database can be deployed by this chart or be provided externally. 
We strongly recommend that you do not deploy a production database using this chart, the provided database is primarily for testing purposes.
The provided database will **not** persist your data by default.

An external database will require some minimal setup for Hasura.
The following needs to be run or the user should have permissions to execute it and Hasura will run it on startup:

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
SET TIME ZONE 'UTC';
```

## Versioning

The Helm chart in this repo is set to use the `latest` images for Prefect infrastructure by default.
The default `imagePullPolicy` is `Always` so these images will be updated when your deployments are rolled over.
This could result in some deployments being on mismatched versions which may not be guaranteed to work well together.
For production usage, we recommend setting the `prefectVersion` value to a specific tag to avoid unexpected upgrades.

When the Helm chart is published to a chart repository, we will pin the version for you.

##  Connecting to your Server

When you run `prefect backend server`, it configures the CLI to expect Server interactions rather than Prefect Cloud. By default, the CLI looks for the Server API at `localhost`. To connect the CLI to your newly deployed server, you'll either need to point the CLI to an external IP or forward the service to `localhost`
### Configure `prefect` to point to your service

To designate your local `prefect` to point to the Kubernetes server, 
you can change the host in the user configuration file `~/.prefect/config.toml`.

```
[server]
  host = "http://<EXTERNAL-IP>"
  [server.ui]
    apollo_url="http://<EXTERNAL-IP>:4200/graphql"
```
Run `kubectl get services --namespace <namespace>` to obtain the Apollo API external ip address.
To review the configuration file run `prefect config`.
 
### Forward your service to localhost 

Alternatively, you can port-forward the apollo service to your localhost 
`kubectl port-forward svc/<APOLO-SERVICE> 4200:4200 -n <namespace>`. 


## Troubleshooting

### The UI loads but the dashboard is blank

If you go to the 'Home' page it will likely direct you to create a tenant. Without a tenant, the dashboard cannot display.
Run `prefect backend server && prefect server create-tenant --name default --slug default` to create a default tenant.

Check out [Connecting to your Server](#connecting-to-your-server) to connect your local `prefect` to your server before creating the tenant.

### The UI loads but cannot connect to the API

Check that the API url is correct under the `server_url` key at the UI url `/settings.json` e.g. `http://localhost:8080/settings.json`.
This should match the url that the Apollo service is deployed to e.g. `http://localhost:4200/graphql`
This endpoint must be accessible by *the user* of the UI, not just the server, since requests come from the user's browser.

### The database deploys correctly but other services fail with "bad password"

If you are using the subchart deployed database with persistence enabled, 
it is likely the password for the user has persisted between deployments in the PVC for the database but the secret has been regenerated by the Helm chart and does not match. 
Deploy and set the 'postgresql.existingSecret' option or set a constant password at `postgresql.postgresqlPassword`.

### The agent is running but when I look at the logs I am getting GraphQL errors

The following error is typically caused by the lack of a tenant. Create a default tenant and the agent will restart automatically.
```
[2020-11-13 19:16:02,083] ERROR - agent | 400 Client Error: Bad Request for url: http://my-release-apollo.default:4200/graphql

This is likely caused by a poorly formatted GraphQL query or mutation. GraphQL sent:

query {
    mutation($input: get_runs_in_queue_input!) {
            get_runs_in_queue(input: $input) {
                flow_run_ids
        }
    }
}
variables {
    {"input": {"before": "2020-11-13T19:16:01.973734+00:00", "labels": [], "tenant_id": null}}
}
```
